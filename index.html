<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QC Torque Analytics & Recorder (Cloud Hybrid)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; }
        .chart-container { position: relative; width: 100%; height: 250px; }
        .modal-scroll::-webkit-scrollbar { width: 4px; }
        .modal-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .modal-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; opacity: 0; transform: translateY(20px); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast-success { background: #059669; color: white; }
        .toast-info { background: #3b82f6; color: white; }
        .toast-undo { background: #1e293b; color: white; }
        .toast-error { background: #ef4444; color: white; }
        #mobile-menu { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        #mobile-menu.open { max-height: 400px; opacity: 1; }
        .touch-target { min-height: 44px; min-width: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* Login Overlay */
        #login-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
        #login-overlay.hidden-overlay { opacity: 0; pointer-events: none; }
        
        /* Sortable Header Style */
        th.sortable { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        th.sortable:hover { background-color: #e2e8f0; }
        th.sortable .sort-icon { display: inline-block; width: 14px; height: 14px; vertical-align: middle; margin-left: 4px; color: #94a3b8; }
        th.sortable.asc .sort-icon { color: #2563eb; transform: rotate(180deg); }
        th.sortable.desc .sort-icon { color: #2563eb; }

        /* Loading Spinner Helper */
        .btn-loading { pointer-events: none; opacity: 0.7; }
        .btn-loading svg { display: none; }
        .btn-loading::after {
            content: "";
            width: 1rem; height: 1rem;
            border: 2px solid #fff; border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Connection Status Badge */
        .status-badge-online { background-color: #10b981; color: white; }
        .status-badge-offline { background-color: #f59e0b; color: white; }

        /* Lang Switcher */
        .lang-btn { font-size: 0.75rem; font-weight: bold; padding: 4px 8px; border-radius: 6px; transition: all 0.2s; cursor: pointer; }
        .lang-btn.active { background-color: #2563eb; color: white; }
        .lang-btn.inactive { background-color: transparent; color: #94a3b8; border: 1px solid #cbd5e1; }
        .lang-btn.inactive:hover { background-color: #f1f5f9; color: #64748b; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-24">

    <div id="login-overlay">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4 transform transition-all duration-300 scale-100 relative">
            <div class="absolute top-4 right-4 flex gap-1 bg-slate-100 p-1 rounded-lg">
                <button onclick="changeLanguage('th')" class="lang-btn" id="lang-th-login">TH</button>
                <button onclick="changeLanguage('en')" class="lang-btn" id="lang-en-login">EN</button>
            </div>

            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-600/30">
                    <i data-lucide="sheet" class="w-8 h-8 text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800" data-i18n="login_title">System Login</h1>
                <p class="text-slate-500 text-sm mt-1">QC Torque (Cloud Hybrid)</p>
            </div>
            
            <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase" data-i18n="login_user_label">Username / ID</label>
                    <div class="relative">
                        <i data-lucide="user" class="w-5 h-5 absolute left-3 top-3 text-slate-400"></i>
                        <input type="text" id="login-id" class="w-full pl-10 pr-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" data-placeholder="login_user_ph" placeholder="Enter ID" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase" data-i18n="login_pass_label">Password</label>
                    <div class="relative">
                        <i data-lucide="lock" class="w-5 h-5 absolute left-3 top-3 text-slate-400"></i>
                        <input type="password" id="login-pass" class="w-full pl-10 pr-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" data-placeholder="login_pass_ph" placeholder="Enter Password" required>
                    </div>
                </div>
                <button type="submit" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-600/30 transition active:scale-95 flex items-center justify-center gap-2">
                    <span data-i18n="login_btn">Sign In</span>
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </form>
        </div>
    </div>

    <header class="bg-blue-800 text-white shadow-lg sticky top-0 z-30 select-none hidden" id="app-header">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-white/10 p-2 rounded-lg">
                        <i data-lucide="sheet" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold tracking-tight leading-tight" data-i18n="app_name">QC Torque Control</h1>
                        <div class="flex items-center gap-2">
                            <span id="user-display" class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-600 text-white flex items-center gap-1">
                                <i data-lucide="user" class="w-3 h-3"></i> <span id="current-user-name">Guest</span>
                            </span>
                            <span id="connection-status" class="px-1.5 py-0.5 rounded text-[10px] font-bold status-badge-offline transition-colors duration-300">Offline</span>
                            <button id="btn-sync" onclick="SyncManager.manualSync()" class="hidden px-2 py-0.5 rounded text-[10px] bg-blue-500 hover:bg-blue-400 text-white flex items-center gap-1 transition">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i> Sync
                            </button>
                        </div>
                    </div>
                </div>

                <div class="hidden md:flex items-center gap-3">
                    <div class="flex gap-1 bg-blue-900/50 p-1 rounded-lg mr-2">
                        <button onclick="changeLanguage('th')" class="px-2 py-0.5 text-xs font-bold rounded transition text-blue-200 hover:text-white" id="lang-th-header">TH</button>
                        <div class="w-px bg-blue-700 h-4 self-center"></div>
                        <button onclick="changeLanguage('en')" class="px-2 py-0.5 text-xs font-bold rounded transition text-blue-200 hover:text-white" id="lang-en-header">EN</button>
                    </div>

                    <button onclick="AuthManager.logout()" class="flex items-center gap-1 bg-red-600/80 hover:bg-red-600 px-3 py-1.5 rounded text-xs font-bold transition shadow-sm">
                        <i data-lucide="log-out" class="w-3 h-3"></i> <span data-i18n="btn_logout">Logout</span>
                    </button>

                    <nav class="flex bg-blue-900/50 p-1 rounded-lg">
                        <button onclick="switchView('dashboard')" id="nav-dashboard-desk" class="px-3 py-1.5 rounded-md text-sm font-medium transition flex items-center gap-2 text-white bg-blue-700 shadow">
                            <i data-lucide="bar-chart-3" class="w-4 h-4"></i> <span data-i18n="menu_dashboard">Dashboard</span>
                        </button>
                        <button onclick="switchView('form')" id="nav-form-desk" class="px-3 py-1.5 rounded-md text-sm font-medium transition flex items-center gap-2 text-blue-200 hover:text-white hover:bg-blue-700/50">
                            <i data-lucide="clipboard-edit" class="w-4 h-4"></i> <span data-i18n="menu_record">Record</span>
                        </button>
                        <button onclick="switchView('history')" id="nav-history-desk" class="px-3 py-1.5 rounded-md text-sm font-medium transition flex items-center gap-2 text-blue-200 hover:text-white hover:bg-blue-700/50">
                            <i data-lucide="history" class="w-4 h-4"></i> <span data-i18n="menu_history">History</span>
                        </button>
                        <button onclick="switchView('settings')" id="nav-settings-desk" class="px-3 py-1.5 rounded-md text-sm font-medium transition flex items-center gap-2 text-blue-200 hover:text-white hover:bg-blue-700/50">
                            <i data-lucide="settings" class="w-4 h-4"></i> <span data-i18n="menu_settings">Settings</span>
                        </button>
                    </nav>
                </div>

                <button class="md:hidden p-2 text-blue-200 hover:text-white hover:bg-blue-700 rounded-lg transition touch-target" onclick="toggleMobileMenu()" aria-label="Toggle Menu">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="mobile-menu" class="md:hidden mt-2 border-t border-blue-700 pt-2 space-y-2 pb-2">
                <button onclick="switchView('dashboard'); toggleMobileMenu()" id="nav-dashboard-mob" class="w-full px-4 py-3 rounded-lg text-sm font-medium transition flex items-center gap-3 text-white bg-blue-700 shadow active:scale-95">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i> <span data-i18n="menu_dashboard">Dashboard</span>
                </button>
                <button onclick="switchView('form'); toggleMobileMenu()" id="nav-form-mob" class="w-full px-4 py-3 rounded-lg text-sm font-medium transition flex items-center gap-3 text-blue-100 hover:bg-blue-700 hover:text-white active:scale-95">
                    <i data-lucide="clipboard-edit" class="w-5 h-5"></i> <span data-i18n="menu_record">Record</span>
                </button>
                <button onclick="switchView('history'); toggleMobileMenu()" id="nav-history-mob" class="w-full px-4 py-3 rounded-lg text-sm font-medium transition flex items-center gap-3 text-blue-100 hover:bg-blue-700 hover:text-white active:scale-95">
                    <i data-lucide="history" class="w-5 h-5"></i> <span data-i18n="menu_history">History</span>
                </button>
                <button onclick="switchView('settings'); toggleMobileMenu()" id="nav-settings-mob" class="w-full px-4 py-3 rounded-lg text-sm font-medium transition flex items-center gap-3 text-blue-100 hover:bg-blue-700 hover:text-white active:scale-95">
                    <i data-lucide="settings" class="w-5 h-5"></i> <span data-i18n="menu_settings">Settings</span>
                </button>
                 <div class="flex justify-center gap-4 py-2 border-t border-blue-700 mt-2">
                    <button onclick="changeLanguage('th')" class="text-blue-200 font-bold hover:text-white">ภาษาไทย</button>
                    <span class="text-blue-500">|</span>
                    <button onclick="changeLanguage('en')" class="text-blue-200 font-bold hover:text-white">English</button>
                </div>
                <div class="border-t border-blue-700 pt-2 mt-2">
                     <button onclick="AuthManager.logout()" class="w-full px-4 py-3 rounded-lg text-sm font-medium transition flex items-center gap-3 text-red-200 hover:bg-red-700 hover:text-white active:scale-95">
                        <i data-lucide="log-out" class="w-5 h-5"></i> <span data-i18n="btn_logout">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 space-y-6 hidden" id="main-container">
        <div id="view-dashboard" class="fade-in space-y-6">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row gap-4 items-center justify-between">
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <i data-lucide="calendar-range" class="w-5 h-5 text-blue-500"></i>
                    <span class="font-bold text-slate-700" data-i18n="filter_range">Filter Range:</span>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="date" id="dash-date-start" class="border rounded p-2 text-sm w-full md:w-auto touch-target h-10" onchange="window.updateDashboard()">
                    <span class="self-center text-slate-400" data-i18n="label_to">to</span>
                    <input type="date" id="dash-date-end" class="border rounded p-2 text-sm w-full md:w-auto touch-target h-10" onchange="window.updateDashboard()">
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <h2 class="text-lg font-bold text-slate-800 mb-2" data-i18n="dash_quality_overview">ภาพรวมคุณภาพ (Quality Overview)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="flex flex-col items-center">
                        <h3 class="text-sm font-semibold text-slate-600 mb-4" data-i18n="dash_ratio">อัตราส่วนผ่านเกณฑ์ (Pass/Fail Ratio)</h3>
                        <div class="chart-container w-full flex justify-center"><canvas id="chart-ratio"></canvas></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <h3 class="text-sm font-semibold text-slate-600 mb-4" data-i18n="dash_activity">จำนวนการตรวจสอบแยกตามไลน์ (Inspection by Line)</h3>
                        <div class="chart-container w-full"><canvas id="chart-activity"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <p class="text-xs text-blue-500 font-bold uppercase" data-i18n="stat_total">Total Records</p>
                    <p class="text-2xl font-bold text-blue-700" id="stat-total">0</p>
                </div>
                <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                    <p class="text-xs text-green-500 font-bold uppercase" data-i18n="stat_passed">Passed</p>
                    <p class="text-2xl font-bold text-green-700" id="stat-pass">0</p>
                </div>
                <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                    <p class="text-xs text-red-500 font-bold uppercase" data-i18n="stat_failed">Failed</p>
                    <p class="text-2xl font-bold text-red-700" id="stat-fail">0</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                    <p class="text-xs text-purple-500 font-bold uppercase" data-i18n="stat_selected">Selected Range</p>
                    <p class="text-2xl font-bold text-purple-700" id="stat-today">0</p>
                </div>
            </div>
        </div>

        <div id="view-settings" class="hidden fade-in space-y-6">
            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="settings" class="w-5 h-5"></i> <span data-i18n="set_title">ตั้งค่าระบบ (Configuration)</span>
            </h2>

            <div class="flex space-x-1 bg-slate-200 p-1 rounded-lg w-full overflow-x-auto">
                <button onclick="switchSettingsTab('standards')" id="tab-standards" class="flex-1 min-w-[80px] px-2 py-2 text-sm rounded-md font-medium bg-white shadow text-blue-700 whitespace-nowrap text-center touch-target" data-i18n="set_tab_std">Standards</button>
                <button onclick="switchSettingsTab('users')" id="tab-users" class="hidden flex-1 min-w-[80px] px-2 py-2 text-sm rounded-md font-medium text-slate-600 hover:bg-white/50 whitespace-nowrap flex items-center justify-center gap-1 touch-target">
                     <i data-lucide="users" class="w-3 h-3"></i> <span data-i18n="set_tab_users">Users</span>
                </button>
                <button onclick="switchSettingsTab('tools')" id="tab-tools" class="flex-1 min-w-[80px] px-2 py-2 text-sm rounded-md font-medium text-slate-600 hover:bg-white/50 whitespace-nowrap flex items-center justify-center gap-1 touch-target">
                    <i data-lucide="database" class="w-3 h-3"></i> <span data-i18n="set_tab_data">Data</span>
                </button>
            </div>

            <div id="settings-standards" class="settings-content bg-white p-6 rounded-xl border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700" data-i18n="set_std_header">Add/Edit Torque Standards</h3>
                    <div class="flex gap-2">
                         <button onclick="clearConfig('standards')" class="px-3 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 rounded-lg text-xs font-bold flex items-center gap-1 transition">
                            <i data-lucide="trash-2" class="w-3 h-3"></i> Clear
                        </button>
                    </div>
                </div>
                
                <div id="edit-mode-indicator" class="hidden mb-2 px-3 py-2 bg-yellow-50 border border-yellow-200 rounded text-yellow-700 text-sm flex justify-between items-center">
                    <span><i data-lucide="edit-2" class="inline w-3 h-3 mr-1"></i> Editing Standard Index: <span id="edit-index" class="font-bold"></span></span>
                    <button onclick="cancelEditStandard()" class="text-xs underline hover:text-yellow-900">Cancel</button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 items-end">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">MAIN MODEL</label>
                        <input type="text" id="cfg-std-group" class="w-full p-2 border rounded-md text-sm h-9" placeholder="e.g. CU Classic">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">SUB MODEL</label>
                        <input type="text" id="cfg-std-sub" class="w-full p-2 border rounded-md text-sm h-9" placeholder="e.g. S9HCL110">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">MODEL BY TORQ</label>
                        <input type="text" id="cfg-std-torq-model" class="w-full p-2 border rounded-md text-sm h-9" placeholder="e.g. LC 250LUG">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">LINE</label>
                        <input type="text" id="cfg-std-line" class="w-full p-2 border rounded-md text-sm h-9" placeholder="1, 4...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">STATION</label>
                        <input type="text" id="cfg-std-station" class="w-full p-2 border rounded-md text-sm h-9" placeholder="St.">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">PART NO <span class="text-red-500">*</span></label>
                        <input type="text" id="cfg-std-part" list="list-parts-settings" class="w-full p-2 border rounded-md text-sm h-9" placeholder="Part No.">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">MIN (N.m)</label>
                        <input type="number" step="0.01" id="cfg-std-min" class="w-full p-2 border rounded-md text-sm h-9" onblur="checkConfigMinMax()">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">MAX (N.m)</label>
                        <input type="number" step="0.01" id="cfg-std-max" class="w-full p-2 border rounded-md text-sm h-9" onblur="checkConfigMinMax()">
                    </div>
                </div>
                <button onclick="addConfigStandard()" id="btn-add-standard" class="w-full mb-4 px-4 py-3 bg-blue-600 text-white rounded-md text-sm font-bold hover:bg-blue-700 flex items-center justify-center gap-2 shadow-sm transition active:scale-95 touch-target">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> <span data-i18n="btn_add_std">Add Standard</span>
                </button>
                <div class="overflow-x-auto max-h-80 overflow-y-auto border rounded-lg">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 text-xs uppercase sticky top-0">
                            <tr>
                                <th class="p-3 sortable" onclick="handleSortConfig('standards', 'modelGroup', this)">Main Model <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="p-3 sortable" onclick="handleSortConfig('standards', 'modelByTorq', this)">Model by Torq <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="p-3 sortable" onclick="handleSortConfig('standards', 'subModel', this)">Sub Model <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="p-3 sortable" onclick="handleSortConfig('standards', 'line', this)">Line <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="p-3 sortable" onclick="handleSortConfig('standards', 'station', this)">St. <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="p-3 sortable" onclick="handleSortConfig('standards', 'part', this)">Part <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="p-3 text-center sortable" onclick="handleSortConfig('standards', 'minNm', this)">Min <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="p-3 text-center sortable" onclick="handleSortConfig('standards', 'maxNm', this)">Max <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="p-3 w-24 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-cfg-standards" class="divide-y"></tbody>
                    </table>
                </div>
                
                <div class="mt-8 border-t pt-6">
                    <h4 class="font-bold text-slate-700 mb-4" data-i18n="set_manage_parts">Manage Unique Parts</h4>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="cfg-part-new" class="flex-1 p-2 border rounded-md text-sm h-10" data-placeholder="ph_add_part" placeholder="Add new part number...">
                        <button onclick="addManualPart()" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-bold hover:bg-blue-700 touch-target" data-i18n="btn_add_part">Add Part</button>
                    </div>
                    <div class="overflow-x-auto max-h-40 overflow-y-auto border rounded-lg">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-xs uppercase sticky top-0">
                                <tr>
                                    <th class="p-2 sortable" onclick="handleSortConfig('parts', 'part', this)">Part Number <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                    <th class="p-2 w-16">Act</th>
                                </tr>
                            </thead>
                            <tbody id="table-cfg-parts" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="settings-users" class="settings-content hidden bg-white p-6 rounded-xl border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700" data-i18n="set_user_mgmt">User Management</h3>
                    <div class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">
                        <i data-lucide="info" class="w-3 h-3 inline"></i> Only Admins can manage users
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl mb-6">
                    <h4 class="text-sm font-bold text-blue-700 mb-3 flex items-center gap-2">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> <span data-i18n="set_create_user">Create / Update User</span>
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">USERNAME (ID)</label>
                            <input type="text" id="user-id-input" class="w-full p-2.5 border rounded-md text-sm h-10 bg-white" placeholder="Employee ID">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">FULL NAME</label>
                            <input type="text" id="user-name-input" class="w-full p-2.5 border rounded-md text-sm h-10 bg-white" placeholder="Name">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">PASSWORD</label>
                            <input type="password" id="user-pass-input" class="w-full p-2.5 border rounded-md text-sm h-10 bg-white" placeholder="New Password (or blank)">
                        </div>
                         <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">ROLE</label>
                            <select id="user-role-input" class="w-full p-2.5 border rounded-md text-sm h-10 bg-white">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="AuthManager.saveUser()" id="btn-save-user" class="mt-4 w-full md:w-auto px-6 py-2.5 bg-blue-600 text-white rounded-md text-sm font-bold hover:bg-blue-700 shadow-sm transition flex items-center justify-center gap-2">
                        Save User
                    </button>
                </div>
                
                <div class="overflow-x-auto border rounded-lg">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 text-xs uppercase">
                            <tr>
                                <th class="p-3 sortable" onclick="handleSortConfig('users', 'id', this)">Username (ID) <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="p-3 sortable" onclick="handleSortConfig('users', 'name', this)">Name <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="p-3 sortable" onclick="handleSortConfig('users', 'role', this)">Role <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="p-3 text-slate-500">Password</th>
                                <th class="p-3 text-center sortable" onclick="handleSortConfig('users', 'isActive', this)">Status <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="p-3 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-users" class="divide-y"></tbody>
                    </table>
                </div>
            </div>

            <div id="settings-tools" class="settings-content hidden bg-white p-6 rounded-xl border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <i data-lucide="database" class="w-5 h-5 text-blue-600"></i> <span data-i18n="set_data_mgmt">Data Management Tools</span>
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border border-slate-200 rounded-lg p-5 bg-slate-50">
                        <h4 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4 text-blue-500"></i>
                            1. Download Templates
                        </h4>
                        <div class="grid grid-cols-1 gap-2">
                            <button onclick="downloadTemplate('models')" class="w-full px-4 py-3 bg-white border border-slate-300 text-slate-700 hover:bg-blue-50 hover:border-blue-300 rounded-lg text-sm font-bold flex items-center justify-between transition active:scale-95 touch-target">
                                <span>Models Template</span>
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                            </button>
                            <button onclick="downloadTemplate('standards')" class="w-full px-4 py-3 bg-white border border-slate-300 text-slate-700 hover:bg-blue-50 hover:border-blue-300 rounded-lg text-sm font-bold flex items-center justify-between transition active:scale-95 touch-target">
                                <span>Standards Template (New Format)</span>
                                <i data-lucide="gauge" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div class="border border-slate-200 rounded-lg p-5 bg-slate-50 flex flex-col">
                        <h4 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                            <i data-lucide="upload" class="w-4 h-4 text-emerald-500"></i>
                            2. Smart Import
                        </h4>
                        <input type="file" id="file-import" accept=".csv" class="hidden" onchange="importData(event)">
                        <button onclick="document.getElementById('file-import').click()" class="mt-auto w-full px-4 py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm shadow-md flex items-center justify-center gap-2 transition transform active:scale-95 touch-target">
                            <i data-lucide="file-up" class="w-5 h-5"></i> <span data-i18n="btn_import">Select CSV File to Import</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-form" class="hidden fade-in space-y-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-bold text-slate-800" data-i18n="rec_title">บันทึกผลการตรวจสอบ (New Inspection)</h2>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">PRODUCTION LINE <span class="text-red-500">*</span></label>
                        <select id="input-line" onchange="handleLineChange(this.value)" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm touch-target h-12">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">TRIGGER EVENT</label>
                        <select id="input-trigger" onchange="updateFormData('trigger', this.value)" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm touch-target h-12">
                            <option value="Shift Change">Shift Change (เปลี่ยนกะ)</option>
                            <option value="Model Change">Model Change (เปลี่ยนรุ่น)</option>
                            <option value="Auditing">Auditing (สุ่มตรวจ)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">SHIFT</label>
                        <select id="input-shift" onchange="updateFormData('shift', this.value)" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm touch-target h-12">
                            <option value="A">Shift A</option>
                            <option value="B">Shift B</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">LEADER (TESTER) <span class="text-red-500">*</span></label>
                        <div class="flex gap-2">
                            <input type="text" id="input-leader" list="list-users-active" oninput="updateFormData('leaderName', this.value)" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm touch-target h-12" placeholder="Scan/Select User...">
                            
                            <button onclick="openQuickAddUser('Leader')" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg shadow transition active:scale-95 touch-target" title="Add New Person">
                                <i data-lucide="user-plus" class="w-5 h-5"></i>
                            </button>
                            
                            <button onclick="quickDeleteUser('Leader')" class="bg-red-50 hover:bg-red-100 text-red-500 border border-red-200 p-3 rounded-lg shadow-sm transition active:scale-95 touch-target" title="Delete Selected Person">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">QC (RECORDER) <span class="text-red-500">*</span></label>
                        <div class="flex gap-2">
                            <input type="text" id="input-qc" list="list-users-active" oninput="updateFormData('qcName', this.value)" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm touch-target h-12" placeholder="Scan/Select User...">
                            
                            <button onclick="openQuickAddUser('QC')" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg shadow transition active:scale-95 touch-target" title="Add New Person">
                                <i data-lucide="user-plus" class="w-5 h-5"></i>
                            </button>
                            
                            <button onclick="quickDeleteUser('QC')" class="bg-red-50 hover:bg-red-100 text-red-500 border border-red-200 p-3 rounded-lg shadow-sm transition active:scale-95 touch-target" title="Delete Selected Person">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <datalist id="list-users-active"></datalist>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">MAIN MODEL FAMILY <span class="text-red-500">*</span></label>
                        <input type="text" id="input-main-model" list="list-main-models" oninput="handleMainModelChange(this.value)" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm touch-target h-12" placeholder="Select or Type...">
                        <datalist id="list-main-models"></datalist>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">SUB MODEL</label>
                        <input type="text" id="input-sub-model" list="list-sub-models" oninput="updateFormData('subModel', this.value); window.loadItemsFromStandard()" disabled class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none disabled:bg-slate-100 disabled:text-slate-400 transition text-sm touch-target h-12" placeholder="Select Main Model first...">
                        <datalist id="list-sub-models"></datalist>
                    </div>
                </div>
            </div>

            <div id="torque-section" class="hidden bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 bg-slate-50 border-b border-slate-200 flex flex-col md:flex-row justify-between items-center gap-2">
                    <div>
                        <h3 class="font-bold text-slate-700 flex items-center gap-2">
                            <i data-lucide="list-checks" class="w-4 h-4 text-blue-500"></i> <span data-i18n="rec_points">Inspection Points</span>
                        </h3>
                        <span id="label-context" class="text-xs font-mono text-slate-500"></span>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50/50">
                            <tr>
                                <th class="px-4 py-3 cursor-pointer hover:bg-slate-100 transition select-none group" onclick="sortItems('station')">
                                    <div class="flex items-center gap-1">
                                        <span>St.</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-300 group-hover:text-slate-500"></i>
                                    </div>
                                </th>
                                <th class="px-4 py-3 cursor-pointer hover:bg-slate-100 transition select-none group" onclick="sortItems('part')">
                                    <div class="flex items-center gap-1">
                                        <span>Part Number</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-300 group-hover:text-slate-500"></i>
                                    </div>
                                </th>
                                <th class="px-4 py-3 text-center cursor-pointer hover:bg-slate-100 transition select-none group" onclick="sortItems('min')">
                                    <div class="flex items-center justify-center gap-1">
                                        <span>Min (N.m)</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-300 group-hover:text-slate-500"></i>
                                    </div>
                                </th>
                                <th class="px-4 py-3 text-center cursor-pointer hover:bg-slate-100 transition select-none group" onclick="sortItems('max')">
                                    <div class="flex items-center justify-center gap-1">
                                        <span>Max (N.m)</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-300 group-hover:text-slate-500"></i>
                                    </div>
                                </th>
                                <th class="px-4 py-3 cursor-pointer hover:bg-slate-100 transition select-none group" onclick="sortItems('actual')">
                                    <div class="flex items-center gap-1">
                                        <span>Actual</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-300 group-hover:text-slate-500"></i>
                                    </div>
                                </th>
                                <th class="px-4 py-3 text-center cursor-pointer hover:bg-slate-100 transition select-none group" onclick="sortItems('status')">
                                    <div class="flex items-center justify-center gap-1">
                                        <span>Status</span>
                                        <i data-lucide="arrow-up-down" class="w-3 h-3 text-slate-300 group-hover:text-slate-500"></i>
                                    </div>
                                </th>
                                <th class="px-4 py-3 text-center w-28">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>

                <div class="p-4 bg-slate-50 border-t border-slate-200 space-y-4">
                    <button onclick="addManualItem()" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-lg text-slate-500 hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition flex items-center justify-center gap-2 text-sm font-medium active:bg-slate-100 touch-target">
                        <i data-lucide="plus" class="w-4 h-4"></i> <span data-i18n="btn_add_manual">Add Manual Check</span>
                    </button>
                    <div class="flex flex-col items-center gap-2 pt-2">
                        <button onclick="submitData()" id="btn-submit" class="w-full md:w-auto px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md font-bold flex items-center justify-center gap-2 transition disabled:bg-slate-300 active:scale-95 touch-target h-12">
                            <i data-lucide="save" class="w-5 h-5"></i> <span data-i18n="btn_save">Save Record</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <datalist id="list-parts"></datalist>
            <datalist id="list-parts-settings"></datalist>
        </div>

        <div id="view-history" class="hidden fade-in space-y-6">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row gap-4 items-center justify-between mb-4">
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <i data-lucide="filter" class="w-5 h-5 text-blue-500"></i>
                    <span class="font-bold text-slate-700" data-i18n="hist_filter">Date Filter:</span>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="date" id="hist-date-start" class="border rounded p-2 text-sm w-full md:w-auto touch-target h-10" onchange="window.renderHistoryTable()">
                    <span class="self-center text-slate-400" data-i18n="label_to">to</span>
                    <input type="date" id="hist-date-end" class="border rounded p-2 text-sm w-full md:w-auto touch-target h-10" onchange="window.renderHistoryTable()">
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                <h2 class="text-lg font-bold text-slate-800" data-i18n="hist_title">ประวัติการตรวจสอบ (History Log)</h2>
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="clearHistory()" class="flex-1 md:flex-none px-4 py-3 bg-red-50 text-red-600 border border-red-200 rounded-lg flex items-center justify-center gap-2 text-sm transition active:bg-red-100 touch-target cursor-pointer">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> <span data-i18n="btn_clear_local">Clear (Local)</span>
                    </button>
                    <button onclick="exportToCSV()" class="flex-1 md:flex-none px-4 py-3 bg-emerald-600 text-white rounded-lg flex items-center justify-center gap-2 text-sm transition active:bg-emerald-700 touch-target cursor-pointer">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> <span data-i18n="btn_export">Export CSV</span>
                    </button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-100">
                            <tr>
                                <th class="px-4 py-3 sortable" onclick="handleSortHistory('timestamp', this)">Date <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="px-4 py-3 text-center sortable" onclick="handleSortHistory('line', this)">Line <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="px-4 py-3 sortable" onclick="handleSortHistory('model', this)">Model <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="px-4 py-3 sortable" onclick="handleSortHistory('leader', this)">QC/Leader <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="px-4 py-3 text-center sortable" onclick="handleSortHistory('result', this)">Result <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                <th class="px-4 py-3 text-center">Detail</th>
                                <th class="px-4 py-3 text-center"></th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <div id="detail-modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95 transition-all duration-300">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800" data-i18n="modal_detail_title">Inspection Details</h3>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full transition"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto modal-scroll"></div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-xl flex justify-end">
                <button onclick="closeModal()" class="px-4 py-2 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 rounded-lg font-bold text-sm transition">Close</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

   <div id="quick-add-modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-[10000] p-4 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-all duration-300 p-6">
            <div class="text-center mb-6">
                <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i data-lucide="user-plus" class="w-6 h-6 text-blue-600"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800" data-i18n="modal_add_person">Add New Person</h3>
                <p class="text-xs text-slate-500">For <span id="quick-add-role-label">User</span></p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">EMPLOYEE ID (รหัสพนักงาน)</label>
                    <input type="text" id="quick-id" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="e.g. EMP001">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">FULL NAME (ชื่อ-สกุล)</label>
                    <input type="text" id="quick-name" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="e.g. Somchai Jai-dee">
                </div>
                
                <div id="quick-add-note" class="text-xs text-slate-400 bg-slate-50 p-2 rounded">
                    * Default Password: <b>1234</b> (Change in Settings)
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeQuickAddModal()" class="flex-1 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-bold text-sm transition">Cancel</button>
                <button onclick="saveQuickUser()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm shadow-lg shadow-blue-600/30 transition">Save</button>
            </div>
        </div>
    </div>
    <script>
        // --- TRANSLATION DATA ---
        const i18n = {
            th: {
                login_title: "เข้าสู่ระบบ",
                login_user_label: "รหัสผู้ใช้ / ID",
                login_pass_label: "รหัสผ่าน",
                login_user_ph: "ระบุ ID",
                login_pass_ph: "ระบุรหัสผ่าน",
                login_btn: "เข้าสู่ระบบ",
                app_name: "ระบบควบคุม QC Torque",
                btn_logout: "ออกจากระบบ",
                menu_dashboard: "แดชบอร์ด",
                menu_record: "บันทึกข้อมูล",
                menu_history: "ประวัติ",
                menu_settings: "ตั้งค่า",
                filter_range: "ช่วงเวลา:",
                label_to: "ถึง",
                dash_quality_overview: "ภาพรวมคุณภาพ (Quality Overview)",
                dash_ratio: "อัตราส่วนผ่านเกณฑ์ (Pass/Fail Ratio)",
                dash_activity: "จำนวนการตรวจสอบแยกตามไลน์ (Inspection by Line)",
                stat_total: "จำนวนบันทึก",
                stat_passed: "ผ่านเกณฑ์",
                stat_failed: "ไม่ผ่าน",
                stat_selected: "ช่วงเวลาที่เลือก",
                set_title: "ตั้งค่าระบบ (Configuration)",
                set_tab_std: "มาตรฐาน (Std)",
                set_tab_users: "ผู้ใช้งาน",
                set_tab_data: "จัดการข้อมูล",
                set_std_header: "เพิ่ม/แก้ไข ค่ามาตรฐาน Torque",
                set_manage_parts: "จัดการรายชื่อชิ้นงาน (Parts)",
                ph_add_part: "เพิ่มเลข Part ใหม่...",
                btn_add_part: "เพิ่ม Part",
                set_user_mgmt: "จัดการผู้ใช้งาน",
                set_create_user: "สร้าง / แก้ไข ผู้ใช้",
                set_data_mgmt: "เครื่องมือจัดการข้อมูล",
                btn_import: "เลือกไฟล์ CSV เพื่อนำเข้า",
                btn_add_std: "เพิ่มมาตรฐาน",
                rec_title: "บันทึกผลการตรวจสอบ (New Inspection)",
                rec_points: "จุดตรวจสอบ",
                btn_add_manual: "เพิ่มจุดตรวจแบบกำหนดเอง",
                btn_save: "บันทึกข้อมูล",
                hist_filter: "กรองวันที่:",
                hist_title: "ประวัติการตรวจสอบ (History Log)",
                btn_clear_local: "ลบประวัติ (เครื่องนี้)",
                btn_export: "ส่งออก CSV",
                modal_detail_title: "รายละเอียดการตรวจสอบ",
                modal_add_person: "เพิ่มพนักงานใหม่",
                // Alerts & JS strings
                alert_login_fail: "ไม่พบผู้ใช้หรือรหัสผ่านผิด",
                alert_login_deactive: "บัญชีถูกระงับ",
                alert_sync_success: "ซิงค์ข้อมูลสำเร็จ!",
                alert_save_success: "บันทึกข้อมูลสำเร็จ!",
                alert_delete_confirm: "คุณแน่ใจหรือไม่ที่จะลบรายการนี้?",
                alert_delete_undo_msg: "ลบรายการแล้ว...",
                alert_undo: "ยกเลิก (Undo)",
                val_pass: "ผ่าน",
                val_fail: "ไม่ผ่าน",
                table_no_data: "ไม่พบข้อมูล",
                txt_active: "ใช้งาน",
                txt_inactive: "ระงับ",
                ph_search_user: "สแกน/เลือก ชื่อ...",
                txt_welcome: "ยินดีต้อนรับ"
            },
            en: {
                login_title: "System Login",
                login_user_label: "USERNAME / ID",
                login_pass_label: "PASSWORD",
                login_user_ph: "Enter ID",
                login_pass_ph: "Enter Password",
                login_btn: "Sign In",
                app_name: "QC Torque Control",
                btn_logout: "Logout",
                menu_dashboard: "Dashboard",
                menu_record: "Record",
                menu_history: "History",
                menu_settings: "Settings",
                filter_range: "Filter Range:",
                label_to: "to",
                dash_quality_overview: "Quality Overview",
                dash_ratio: "Pass/Fail Ratio",
                dash_activity: "Inspection by Line",
                stat_total: "Total Records",
                stat_passed: "Passed",
                stat_failed: "Failed",
                stat_selected: "Selected Range",
                set_title: "Configuration",
                set_tab_std: "Standards",
                set_tab_users: "Users",
                set_tab_data: "Data Tools",
                set_std_header: "Add/Edit Torque Standards",
                set_manage_parts: "Manage Unique Parts",
                ph_add_part: "Add new part number...",
                btn_add_part: "Add Part",
                set_user_mgmt: "User Management",
                set_create_user: "Create / Update User",
                set_data_mgmt: "Data Management Tools",
                btn_import: "Select CSV File to Import",
                btn_add_std: "Add Standard",
                rec_title: "New Inspection Record",
                rec_points: "Inspection Points",
                btn_add_manual: "Add Manual Check",
                btn_save: "Save Record",
                hist_filter: "Date Filter:",
                hist_title: "History Log",
                btn_clear_local: "Clear (Local)",
                btn_export: "Export CSV",
                modal_detail_title: "Inspection Details",
                modal_add_person: "Add New Person",
                // Alerts & JS strings
                alert_login_fail: "User not found or incorrect password.",
                alert_login_deactive: "Account deactivated.",
                alert_sync_success: "Configuration Synced!",
                alert_save_success: "Saved successfully!",
                alert_delete_confirm: "Are you sure you want to delete this record?",
                alert_delete_undo_msg: "Record deleted...",
                alert_undo: "Undo",
                val_pass: "PASS",
                val_fail: "FAIL",
                table_no_data: "No data found.",
                txt_active: "Active",
                txt_inactive: "Inactive",
                ph_search_user: "Scan/Select User...",
                txt_welcome: "Welcome"
            }
        };

        window.currentLang = localStorage.getItem('app_lang') || 'th';

        window.t = (key) => {
            return i18n[window.currentLang][key] || key;
        };

        window.changeLanguage = (lang) => {
            window.currentLang = lang;
            localStorage.setItem('app_lang', lang);
            
            // Update UI elements with data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang][key]) el.textContent = i18n[lang][key];
            });

            // Update placehoders
            document.querySelectorAll('[data-placeholder]').forEach(el => {
                const key = el.getAttribute('data-placeholder');
                if (i18n[lang][key]) el.placeholder = i18n[lang][key];
            });

            // Update specific dynamic inputs
            const userInputs = ['input-leader', 'input-qc'];
            userInputs.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.placeholder = t('ph_search_user');
            });

            // Update Button Styles
            updateLangButtons(lang);

            // Re-render Dynamic Content
            if(window.state && window.state.view) {
                if(window.state.view === 'dashboard') window.updateDashboard();
                if(window.state.view === 'history') window.renderHistoryTable();
                if(window.state.view === 'settings') window.renderSettings();
            }
        };

        function updateLangButtons(lang) {
            const btns = {
                'th': ['lang-th-login', 'lang-th-header'],
                'en': ['lang-en-login', 'lang-en-header']
            };
            
            // Reset all
            Object.values(btns).flat().forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.classList.remove('active', 'text-white', 'bg-blue-700'); 
                    el.classList.add('inactive', 'text-blue-200'); // Default header style
                    
                    // Specific fix for login page buttons which have different classes
                    if(id.includes('login')) {
                        el.classList.remove('text-blue-200');
                        el.classList.add('text-slate-400');
                    }
                }
            });

            // Set Active
            btns[lang].forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.classList.remove('inactive', 'text-blue-200', 'text-slate-400');
                    el.classList.add('active'); // active handles bg-blue
                    if(id.includes('header')) el.classList.add('text-white');
                }
            });
        }

        // --- GOOGLE APPS SCRIPT URL ---
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbw005nlitvAWq-kA-rWoGX0B-ovzq9kbT7mroOdLSHERaF12-LjfwDuQM3j0jZBaMTVYg/exec";

        function escapeHtml(text) {
            if (text == null) return ''; 
            const str = String(text);
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        window.state = {
            user: null, // App Level User Data (Role, Name)
            view: 'dashboard',
            formData: { line: '', mainModel: '', subModel: '', leaderName: '', qcName: '', shift: 'A', trigger: 'Shift Change' },
            items: [], historyData: [], charts: { ratio: null, activity: null },
            config: { models: [], standards: [], personnel: [], parts: [], users: [] },
            lastAction: null,
            isOffline: false,
            editStandardIndex: null,
            editingRow: null, // For History Modal Editing
            sort: { column: null, direction: 'asc' },
            sortHistory: { col: 'timestamp', dir: 'desc' }, 
            sortConfig: { 
                models: { col: null, dir: 'asc' },
                standards: { col: null, dir: 'asc' },
                users: { col: null, dir: 'asc' },
                parts: { col: null, dir: 'asc' }
            }
        };

        // --- SERVICE: Google Sheets Interaction ---
        const Service = {
            async init() {
                window.state.isOffline = false;
                await this.loadConfig(); // Load Config First
                this.subscribeHistory(); // Then History
                window.updateStatusUI(true);
            },

           // --- แก้ไขใน object Service ---

            async syncUsersOnly() {
                try {
                    const response = await fetch(`${GAS_API_URL}?action=read_config`);
                    const data = await response.json();
                    
                    // Sync Login Users
                    if (data.users) {
                        window.state.config.users = data.users;
                        localStorage.setItem('cfg_users', JSON.stringify(data.users));
                    }

                    // Sync Personnel (Leader/QC) -- เพิ่มส่วนนี้
                    if (data.personnel) {
                        window.state.config.personnel = data.personnel;
                        localStorage.setItem('cfg_personnel', JSON.stringify(data.personnel));
                    }
                    
                    // Sync Other Configs
                    if(data.models) { window.state.config.models = data.models; localStorage.setItem('cfg_models', JSON.stringify(data.models)); }
                    if(data.standards) { window.state.config.standards = data.standards; localStorage.setItem('cfg_standards', JSON.stringify(data.standards)); }
                    
                    console.log("Cloud Config Synced");
                    return true;
                } catch (e) {
                    console.warn("Sync failed (Offline)", e);
                    throw e;
                }
            },

            async loadConfig() {
                try {
                    const response = await fetch(`${GAS_API_URL}?action=read_config`);
                    const data = await response.json();
                    
                    if (data.models && data.standards) {
                        window.state.config.models = data.models;
                        window.state.config.standards = data.standards;
                        if (data.users) window.state.config.users = data.users;
                        // เพิ่ม Personnel
                        if (data.personnel) window.state.config.personnel = data.personnel;
                        else window.state.config.personnel = []; // ถ้าไม่มีให้เป็น array ว่าง

                        // Save local backup
                        ConfigService.saveLocalOnly();
                        
                        window.populateDropdowns();
                        // เรียกฟังก์ชัน Sync Dropdown ของ Personnel
                        window.syncPersonnelDropdowns(); 
                        
                        window.showToast(t('alert_sync_success'), "success");
                    }
                } catch (e) {
                    console.error("Config Load Error:", e);
                    window.showToast("Failed to load cloud config. Using local.", "error");
                    ConfigService.loadLocal();
                }
            },

            async saveConfig(newConfigData) {
                try {
                    window.showToast("Syncing Config to Cloud...", "info");
                    const payload = { action: 'save_config', payload: newConfigData };
                    await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    window.showToast(t('alert_save_success'), "success");
                } catch (e) {
                    console.error("Config Save Error:", e);
                    window.showToast("Save Config Failed (Offline)", "error");
                }
            },

            async saveRecord(record) {
                try {
                    const payload = { action: 'save_record', payload: record };
                    const response = await fetch(GAS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    if(result.status === 'success') {
                        window.showToast(t('alert_save_success'), "success");
                        this.subscribeHistory();
                    } else {
                        throw new Error(result.message || "Unknown Error");
                    }
                } catch (e) {
                    console.error("Save Error (Cloud):", e);
                    this.saveLocal(record);
                }
            },
            
            saveLocal(record) {
                 const local = JSON.parse(localStorage.getItem('torque_records') || '[]');
                 local.unshift({ 
                    ...record, 
                    id: 'local-' + Date.now(), 
                    timestamp: { seconds: Date.now() / 1000 }, 
                    dateString: new Date().toLocaleString('th-TH') 
                });
                 localStorage.setItem('torque_records', JSON.stringify(local));
                 window.showToast("Saved Offline (Connection Error)", "info");
                 this.subscribeHistory();
            },

            async deleteRecord(id) {
                if (String(id).startsWith('local-')) {
                    let local = JSON.parse(localStorage.getItem('torque_records') || '[]');
                    local = local.filter(i => i.id !== id);
                    localStorage.setItem('torque_records', JSON.stringify(local));
                    this.subscribeHistory();
                    window.showToast("Deleted local record", "undo");
                    return;
                }

                try {
                    await fetch(GAS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'delete_record', payload: { id: id } })
                    });
                    window.showToast("Deleted from Sheet", "success");
                    this.subscribeHistory();
                } catch(e) {
                    console.error(e);
                    window.showToast("Delete failed (Check Connection)", "error");
                }
            },
            
            async updateRecord(id, data) {
                 if (String(id).startsWith('local-')) {
                     let local = JSON.parse(localStorage.getItem('torque_records') || '[]');
                     const idx = local.findIndex(r => r.id === id);
                     if (idx !== -1) {
                         local[idx] = { ...local[idx], ...data };
                         localStorage.setItem('torque_records', JSON.stringify(local));
                         this.subscribeHistory();
                     }
                 } else {
                     alert("Editing Cloud records directly is not supported. Please delete and re-enter.");
                 }
            },

            async subscribeHistory() {
                try {
                    const response = await fetch(`${GAS_API_URL}?action=read_history`);
                    const cloudData = await response.json();
                    const localData = JSON.parse(localStorage.getItem('torque_records') || '[]');
                    window.state.historyData = [...localData, ...cloudData];
                    window.updateDashboard();
                    window.renderHistoryTable();
                    window.state.isOffline = false;
                    window.updateStatusUI(true);
                } catch (e) {
                    console.error("Fetch Error:", e);
                    window.state.isOffline = true;
                    window.updateStatusUI(false);
                    window.state.historyData = JSON.parse(localStorage.getItem('torque_records') || '[]');
                    window.renderHistoryTable();
                }
            }
        };

        // --- AUTH & USER MANAGEMENT (HYBRID) ---
        const AuthManager = {
            async loginAsync(id, pass) {
                const btn = document.getElementById('btn-login');
                const originalHtml = btn.innerHTML;
                
                // 1. UI Loading
                btn.classList.add('btn-loading');
                btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Checking...';
                if(window.lucide) lucide.createIcons();

                try {
                    // 2. Try Syncing Users from Cloud
                    await Service.syncUsersOnly(); 
                } catch (e) {
                    window.showToast("Offline Mode: Logging in with local data", "info");
                }

                // 3. Local Verification (using potentially updated data)
                let users = JSON.parse(localStorage.getItem('cfg_users') || '[]');
                
                if (users.length === 0 && id === 'admin' && pass === '1234') {
                    const admin = { id: 'admin', name: 'System Admin', password: '1234', role: 'admin', isActive: true };
                    users.push(admin);
                    localStorage.setItem('cfg_users', JSON.stringify(users));
                }
                
                const user = users.find(u => u.id === id);
                
                this.resetLoginBtn(btn, originalHtml);

                if (!user) { window.showToast(t('alert_login_fail'), "error"); return false; }
                if (!user.isActive) { alert(t('alert_login_deactive')); return false; }
                
                if (String(user.password) !== String(pass)) { 
                    window.showToast(t('alert_login_fail'), "error"); 
                    return false; 
                }
                
                this.setSession(user);
                return true;
            },
            
            resetLoginBtn(btn, html) {
                btn.classList.remove('btn-loading');
                btn.innerHTML = html;
                if(window.lucide) lucide.createIcons();
            },

            setSession(userData) {
                window.state.user = userData;
                localStorage.setItem('currentUser', JSON.stringify(userData));
                
                document.getElementById('login-overlay').classList.add('hidden-overlay');
                document.getElementById('app-header').classList.remove('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                document.getElementById('current-user-name').textContent = escapeHtml(userData.name);
                
                this.syncUsersList();
                
                const userTab = document.getElementById('tab-users');
                if (userData.role === 'admin') {
                    userTab.classList.remove('hidden');
                } else {
                    userTab.classList.add('hidden');
                }
                
                window.showToast(`${t('txt_welcome')}, ${escapeHtml(userData.name)}!`, 'success');
                Service.init(); 
            },

            logout() {
                window.state.user = null;
                localStorage.removeItem('currentUser');
                location.reload(); 
            },

            async saveUser() {
                const id = document.getElementById('user-id-input').value.trim();
                const name = document.getElementById('user-name-input').value.trim();
                const pass = document.getElementById('user-pass-input').value.trim();
                const role = document.getElementById('user-role-input').value;

                if (!id || !name) { alert("ID and Name are required."); return; }
                
                let users = window.state.config.users;
                const idx = users.findIndex(u => u.id === id);
                
                const newUser = { id, name, role, isActive: true };
                if(pass) newUser.password = pass; 
                
                if (idx >= 0) {
                    users[idx] = { ...users[idx], ...newUser };
                    if (!pass) users[idx].password = users[idx].password; 
                } else {
                    if(!pass) return alert("Password required for new user.");
                    users.push(newUser);
                }
                
                localStorage.setItem('cfg_users', JSON.stringify(users));
                
                document.getElementById('user-id-input').value = '';
                document.getElementById('user-name-input').value = '';
                document.getElementById('user-pass-input').value = '';
                
                this.syncUsersList();
                
                // Auto-sync to cloud
                await Service.saveConfig({
                     models: window.state.config.models,
                     standards: window.state.config.standards,
                     users: users
                });
            },
            
            toggleUserStatus(id, currentStatus) {
                if(id === 'admin') return alert("Cannot deactivate default admin.");
                const u = window.state.config.users.find(u => u.id === id);
                if(u) {
                    u.isActive = !currentStatus;
                    localStorage.setItem('cfg_users', JSON.stringify(window.state.config.users));
                    this.syncUsersList();
                    Service.saveConfig({
                         models: window.state.config.models,
                         standards: window.state.config.standards,
                         users: window.state.config.users
                    });
                }
            },
            
            editUser(id) {
                 const user = window.state.config.users.find(u => u.id === id);
                if (!user) return;
                document.getElementById('user-id-input').value = user.id;
                document.getElementById('user-name-input').value = user.name;
                document.getElementById('user-role-input').value = user.role;
                document.getElementById('user-pass-input').placeholder = "Enter new password to change";
                window.showToast("Editing user: " + escapeHtml(id), "info");
            },

            syncUsersList() {
                window.state.config.users = JSON.parse(localStorage.getItem('cfg_users') || '[]');
                this.renderUsersTable();
                const activeUsers = window.state.config.users.filter(u => u.isActive);
                const options = activeUsers.map(u => `<option value="${escapeHtml(u.name)}">`).join('');
                const list = document.getElementById('list-users-active');
                if(list) list.innerHTML = options;
            },
            
            renderUsersTable() {
                const tbody = document.getElementById('table-users');
                if(!window.state.user || window.state.user.role !== 'admin') {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-400">Restricted Access</td></tr>';
                    return;
                }

                tbody.innerHTML = window.state.config.users.map(u => {
                    const statusBadge = u.isActive 
                        ? `<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold">${t('txt_active')}</span>` 
                        : `<span class="px-2 py-1 bg-gray-100 text-gray-500 rounded text-xs font-bold">${t('txt_inactive')}</span>`;
                    
                    const btnAction = u.isActive 
                        ? `<button onclick="AuthManager.toggleUserStatus('${escapeHtml(u.id)}', true)" class="text-red-500 hover:bg-red-50 px-2 py-1 rounded text-xs border border-red-200">Deactivate</button>`
                        : `<button onclick="AuthManager.toggleUserStatus('${escapeHtml(u.id)}', false)" class="text-green-500 hover:bg-green-50 px-2 py-1 rounded text-xs border border-green-200">Activate</button>`;
                    
                    const btnEdit = `<button onclick="AuthManager.editUser('${escapeHtml(u.id)}')" class="text-blue-500 hover:bg-blue-50 px-2 py-1 rounded text-xs border border-blue-200 mr-1">Edit</button>`;

                    return `
                        <tr class="${!u.isActive ? 'bg-slate-50 opacity-75' : ''} border-b border-slate-100">
                            <td class="p-3 font-mono font-bold text-slate-700">${escapeHtml(u.id)}</td>
                            <td class="p-3">${escapeHtml(u.name)}</td>
                            <td class="p-3 capitalize">${escapeHtml(u.role)}</td>
                            <td class="p-3 font-mono text-sm text-slate-500">******</td>
                            <td class="p-3 text-center">${statusBadge}</td>
                            <td class="p-3 text-center whitespace-nowrap">${btnEdit} ${btnAction}</td>
                        </tr>
                    `;
                }).join('');
            }
        };
        
        // --- SYNC MANAGER (Local -> GAS) ---
        const SyncManager = {
            async manualSync() {
                const localRecs = JSON.parse(localStorage.getItem('torque_records') || '[]');
                const offlineRecs = localRecs.filter(r => String(r.id).startsWith('local-'));
                
                if (offlineRecs.length === 0) return window.showToast("No offline records to sync.", "info");
                
                const btn = document.getElementById('btn-sync');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Syncing...';
                
                window.showToast(`Syncing ${offlineRecs.length} records...`, "info");
                
                let successCount = 0;
                for (const rec of offlineRecs) {
                    try {
                        const payload = { ...rec };
                        delete payload.id; 
                        await fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'save_record', payload: payload })
                        });
                        const currentLocal = JSON.parse(localStorage.getItem('torque_records') || '[]');
                        const newLocal = currentLocal.filter(r => r.id !== rec.id);
                        localStorage.setItem('torque_records', JSON.stringify(newLocal));
                        successCount++;
                    } catch(e) { console.error("Sync failed", e); }
                }
                
                btn.innerHTML = originalText;
                lucide.createIcons();
                if(successCount > 0) {
                    window.showToast(`Synced ${successCount} records!`, "success");
                    Service.subscribeHistory();
                } else {
                    window.showToast("Sync failed. Check connection.", "error");
                }
            }
        };

        // --- GLOBAL UI FUNCTIONS ---
        window.handleLogin = async (e) => {
            e.preventDefault();
            const id = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            await AuthManager.loginAsync(id, pass);
        };

        window.toggleMobileMenu = () => { document.getElementById('mobile-menu').classList.toggle('open'); };
        
        window.switchView = (viewName) => {
            window.state.view = viewName;
            ['dashboard', 'form', 'history', 'settings'].forEach(v => {
                document.getElementById(`view-${v}`).classList.toggle('hidden', v !== viewName);
                const btnDesk = document.getElementById(`nav-${v}-desk`); if (btnDesk) { if (v === viewName) { btnDesk.classList.add('bg-blue-700', 'shadow', 'text-white'); btnDesk.classList.remove('text-blue-200'); } else { btnDesk.classList.remove('bg-blue-700', 'shadow', 'text-white'); btnDesk.classList.add('text-blue-200'); } }
                const btnMob = document.getElementById(`nav-${v}-mob`); if (btnMob) { if (v === viewName) { btnMob.classList.add('bg-blue-700', 'text-white'); btnMob.classList.remove('text-blue-100'); } else { btnMob.classList.remove('bg-blue-700', 'text-white'); btnMob.classList.add('text-blue-100'); } }
            });
            if(viewName === 'dashboard') window.updateDashboard();
            if(viewName === 'history') window.renderHistoryTable();
            if(viewName === 'settings') window.renderSettings();
        };

        window.switchSettingsTab = (tab) => {
            ['standards','users','tools'].forEach(t => {
                const contentEl = document.getElementById(`settings-${t}`);
                const tabEl = document.getElementById(`tab-${t}`);
                if (contentEl) contentEl.classList.add('hidden');
                if (tabEl) tabEl.classList.remove('bg-white','shadow','text-blue-700');
            });
            
            const targetContent = document.getElementById(`settings-${tab}`);
            const targetTab = document.getElementById(`tab-${tab}`);
            if (targetContent) targetContent.classList.remove('hidden');
            if (targetTab) targetTab.classList.add('bg-white','shadow','text-blue-700');
            lucide.createIcons();
        };

        window.sortArray = (data, column, direction) => {
            return data.sort((a, b) => {
                let valA, valB;
                const getVal = (item, col) => {
                    if (col === 'timestamp') return new Date(item.dateString || 0).getTime();
                    if (col === 'model') return (item.mainModel || '') + (item.subModel || '');
                    if (col === 'result') return item.readings.every(r => r.status === 'pass') ? 1 : 0;
                    if (col === 'leader') return (item.leaderName || '') + (item.qcName || '');
                    return item[col];
                };
                valA = getVal(a, column); valB = getVal(b, column);
                const numA = parseFloat(valA), numB = parseFloat(valB);
                if (!isNaN(numA) && !isNaN(numB) && typeof valA !== 'string') { valA = numA; valB = numB; } 
                else { valA = (valA || '').toString().toLowerCase(); valB = (valB || '').toString().toLowerCase(); }
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        };

        window.handleSortHistory = (col, headerElement) => {
            if (window.state.sortHistory.col === col) { window.state.sortHistory.dir = window.state.sortHistory.dir === 'asc' ? 'desc' : 'asc'; } 
            else { window.state.sortHistory.col = col; window.state.sortHistory.dir = 'desc'; }
            document.querySelectorAll('#view-history th.sortable').forEach(th => th.classList.remove('asc', 'desc'));
            headerElement.classList.add(window.state.sortHistory.dir);
            window.renderHistoryTable();
        };
        
        // --- CONFIG MANAGER (UPDATED FOR CLOUD) ---
        const ConfigService = {
           // ใน ConfigService
            loadLocal() {
                // ... (models/standards เดิม) ...
                let models = JSON.parse(localStorage.getItem('cfg_models') || '[]');
                if(models.length === 0) { models = [{main: "CU Classic", sub: "S9HCL110"}]; }
                window.state.config.models = models;

                let standards = JSON.parse(localStorage.getItem('cfg_standards') || '[]');
                if(standards.length === 0) {
                     standards = [{modelGroup:"CU Classic", modelByTorq:"CU Classic", subModel: "S9HCL110", line: "5", station: "6", part: "75504066AA", desc: "Cover screw", minNm: 2.6, maxNm: 3.05}];
                }
                window.state.config.standards = standards;

                // Load Personnel Local
                let personnel = JSON.parse(localStorage.getItem('cfg_personnel') || '[]');
                window.state.config.personnel = personnel;

                window.populateDropdowns();
                window.syncPersonnelDropdowns(); // เรียกตัวนี้ด้วย
            },
            
            saveLocalOnly() {
                localStorage.setItem('cfg_models', JSON.stringify(window.state.config.models));
                localStorage.setItem('cfg_standards', JSON.stringify(window.state.config.standards));
                localStorage.setItem('cfg_users', JSON.stringify(window.state.config.users));
                // Save Personnel
                localStorage.setItem('cfg_personnel', JSON.stringify(window.state.config.personnel));
            },

            save() {
                this.saveLocalOnly();
                // Sync ALL config to cloud
                Service.saveConfig({
                    models: window.state.config.models,
                    standards: window.state.config.standards,
                    users: window.state.config.users
                });
                
                window.populateDropdowns();
            },

            addModel(main, sub) { window.state.config.models.push({ main, sub }); this.save(); },
            removeModel(idx) { window.state.config.models.splice(idx, 1); this.save(); },
            addStandard(std) { 
                if (std.maxNm <= std.minNm) return alert("Error: Max torque must be greater than Min torque.");
                window.state.config.standards.push(std); this.save(); 
            },
            updateStandard(index, std) {
                if (std.maxNm <= std.minNm) return alert("Error: Max torque must be greater than Min torque.");
                window.state.config.standards[index] = std; this.save();
            },
            removeStandard(idx) { window.state.config.standards.splice(idx, 1); this.save(); },
            addUniquePart(part) { /* Legacy support */ },
            removePart(idx) { /* Legacy support */ }
        };

        window.clearConfig = (type) => {
            let data = [];
            if (type === 'models') { data = [...window.state.config.models]; window.state.config.models = []; }
            else if (type === 'standards') { data = [...window.state.config.standards]; window.state.config.standards = []; }
            
            if (data.length === 0) return alert("Nothing to clear.");
            if (!confirm(`Clear all ${type}?`)) return;
            ConfigService.save(); window.renderSettings(); window.showToast(`${type} cleared.`, 'undo');
        };

        window.handleSortConfig = (type, col, headerElement) => {
            const currentSort = window.state.sortConfig[type];
            if (currentSort.col === col) { currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc'; } 
            else { currentSort.col = col; currentSort.dir = 'asc'; }

            let dataArray;
            if (type === 'models') dataArray = window.state.config.models;
            else if (type === 'standards') dataArray = window.state.config.standards;
            else if (type === 'users') dataArray = window.state.config.users;
            else if (type === 'parts') {
                if(col === 'part') window.state.config.parts.sort((a,b) => {
                    const res = a.toLowerCase().localeCompare(b.toLowerCase());
                    return currentSort.dir === 'asc' ? res : -res;
                });
            }

            if (type !== 'parts') window.sortArray(dataArray, col, currentSort.dir);

            const containerId = type === 'users' ? 'table-users' : `table-cfg-${type}`;
            const table = document.getElementById(containerId).closest('table');
            table.querySelectorAll('th.sortable').forEach(th => th.classList.remove('asc', 'desc'));
            headerElement.classList.add(currentSort.dir);

            if (type === 'users') AuthManager.renderUsersTable(); else window.renderSettings();
        };

        // --- FORM & TABLE LOGIC ---
        window.populateDropdowns = () => {
            const mains = [...new Set(window.state.config.models.map(m => m.main))];
            document.getElementById('list-main-models').innerHTML = mains.map(m => `<option value="${escapeHtml(m)}">`).join('');
            
            const stdLines = [...new Set(window.state.config.standards.map(s => String(s.line)))].sort();
            const allLines = [...new Set(['1','4','5','6','Pre-assy', ...stdLines])];
            document.getElementById('input-line').innerHTML = '<option value="">-- Select --</option>' + allLines.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join('');
            
            const partsHtml = window.state.config.parts.map(p => `<option value="${escapeHtml(p)}">`).join('');
            document.getElementById('list-parts').innerHTML = partsHtml; document.getElementById('list-parts-settings').innerHTML = partsHtml;
        };

        window.handleLineChange = (val) => { window.state.formData.line = val; window.loadItemsFromStandard(); };
        window.handleMainModelChange = (val) => {
            window.state.formData.mainModel = val;
            const subList = document.getElementById('list-sub-models'); const subInput = document.getElementById('input-sub-model'); subList.innerHTML = '';
            if (val) {
                const subs = [...new Set(window.state.config.models.filter(m => m.main === val).map(m => m.sub))];
                subList.innerHTML = subs.map(s => `<option value="${escapeHtml(s)}">`).join('');
                subInput.disabled = false; subInput.placeholder = "Select or Type Sub Model...";
            } else { subInput.disabled = true; subInput.value = ''; subInput.placeholder = "Select Main Model first..."; window.updateFormData('subModel', ''); }
            window.loadItemsFromStandard();
        };

        window.loadItemsFromStandard = () => {
            if (!window.state.formData.line) { window.state.items = []; window.renderTable(); return; }
            const selectedMain = (window.state.formData.mainModel || "").toLowerCase();
            const selectedSub = (window.state.formData.subModel || "").toLowerCase();
            const active = window.state.config.standards.filter(s => {
                const lineMatch = String(s.line) === String(window.state.formData.line);
                const mainMatch = selectedMain === (s.modelGroup || "").toLowerCase() || (s.modelGroup || "").toLowerCase().includes(selectedMain);
                const subMatch = !s.subModel || (s.subModel || "").toLowerCase() === selectedSub;
                return lineMatch && mainMatch && subMatch;
            });
            window.state.items = active.map((s, i) => ({ id: `std-${Date.now()}-${i}`, type: 'Standard', station: s.station, part: s.part, desc: s.desc, min: s.minNm, max: s.maxNm, actual: '' }));
            if (!window.state.sort.column) { window.state.sort = { column: 'station', direction: 'asc' }; }
            window.sortItems(window.state.sort.column, false);
        };

        window.sortItems = (column, toggle = true) => {
            if (toggle) { if (window.state.sort.column === column) { window.state.sort.direction = window.state.sort.direction === 'asc' ? 'desc' : 'asc'; } else { window.state.sort.column = column; window.state.sort.direction = 'asc'; } }
            const dir = window.state.sort.direction === 'asc' ? 1 : -1;
            window.state.items.sort((a, b) => {
                let valA = a[column], valB = b[column];
                if (['min', 'max', 'actual'].includes(column)) { valA = parseFloat(valA) || (dir === 1 ? Infinity : -Infinity); valB = parseFloat(valB) || (dir === 1 ? Infinity : -Infinity); } 
                else if (column === 'station') { const numA = parseFloat(valA), numB = parseFloat(valB); if (!isNaN(numA) && !isNaN(numB)) { valA = numA; valB = numB; } else { valA = (valA || '').toString().toLowerCase(); valB = (valB || '').toString().toLowerCase(); } }
                else if (column === 'status') { const getS = (i) => { const a = parseFloat(i.actual); return isNaN(a) ? 0 : (a>=i.min&&a<=i.max ? 1 : 2); }; valA = getS(a); valB = getS(b); }
                else { valA = (valA || '').toString().toLowerCase(); valB = (valB || '').toString().toLowerCase(); }
                if (valA < valB) return -1 * dir; if (valA > valB) return 1 * dir; return 0;
            });
            window.renderTable();
        };

        window.renderTable = () => {
            const container = document.getElementById('torque-section'); const tbody = document.getElementById('table-body'); const label = document.getElementById('label-context');
            if (!window.state.formData.line) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden'); label.textContent = `Line ${escapeHtml(window.state.formData.line)} | Model: ${escapeHtml(window.state.formData.mainModel || 'N/A')}${window.state.formData.subModel ? ' / '+escapeHtml(window.state.formData.subModel) : ''}`;
            tbody.innerHTML = window.state.items.length === 0 ? `<tr><td colspan="7" class="p-8 text-center text-slate-400">No matching standards found for this Line/Model.</td></tr>` : '';
            if (window.state.items.length > 0) {
                 const headerIcon = document.querySelector(`th[onclick="sortItems('${window.state.sort.column}')"] i`);
                 if(headerIcon) { headerIcon.setAttribute('data-lucide', window.state.sort.direction === 'asc' ? 'arrow-up' : 'arrow-down'); headerIcon.classList.add('text-blue-600'); }
                 window.state.items.forEach(item => {
                    const isStd = item.type === 'Standard';
                    const tr = document.createElement('tr'); tr.id = `row-${item.id}`;
                    const stCell = isStd ? `<div class="font-medium text-slate-700">${escapeHtml(item.station)}</div>` : `<input type="text" value="${escapeHtml(item.station)}" oninput="updateItem('${item.id}', 'station', this.value)" class="w-full p-2 border rounded text-xs" placeholder="St.">`;
                    const safePart = escapeHtml(item.part) || '-'; 
                    const partDisplay = isStd ? `<div><div class="text-sm font-bold text-slate-700">${safePart}</div><div class="text-xs text-slate-500">${escapeHtml(item.desc||'')}</div></div>` : `<input type="text" list="list-parts" value="${safePart !== '-' ? safePart : ''}" oninput="updateItem('${item.id}', 'part', this.value)" class="w-full p-2 border rounded text-xs" placeholder="Part Number">`;
                    tr.innerHTML = `<td class="p-3">${stCell}</td><td class="p-3">${partDisplay}</td><td class="p-3 text-center font-mono text-xs">${isStd ? item.min : `<input type="number" step="0.01" value="${item.min}" id="min-${item.id}" oninput="updateItem('${item.id}', 'min', parseFloat(this.value)); window.validateRange('${item.id}')" class="w-16 p-2 border rounded text-xs text-center">`}</td><td class="p-3 text-center font-mono text-xs">${isStd ? item.max : `<input type="number" step="0.01" value="${item.max}" id="max-${item.id}" oninput="updateItem('${item.id}', 'max', parseFloat(this.value)); window.validateRange('${item.id}')" class="w-16 p-2 border rounded text-xs text-center">`}</td><td class="p-3"><input type="number" step="0.01" value="${item.actual}" oninput="updateItem('${item.id}', 'actual', this.value); window.validateStatusUI('${item.id}')" class="w-full p-3 border rounded focus:ring-2 focus:ring-blue-500 outline-none"></td><td class="p-3 text-center status-cell font-bold text-sm"></td><td class="p-3"><div class="flex items-center gap-1 justify-center"><button onclick="duplicateItem('${item.id}')" class="p-2 text-slate-400 hover:text-blue-600 transition touch-target"><i data-lucide="copy-plus" class="w-4 h-4"></i></button><button onclick="removeItem('${item.id}')" class="p-2 text-slate-400 hover:text-red-600 transition touch-target"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td>`;
                    tbody.appendChild(tr); window.validateStatusUI(item.id); if (!isStd) window.validateRange(item.id);
                });
            }
            lucide.createIcons();
        };

        window.validateRange = (id) => { const item = window.state.items.find(i => i.id === id); if (!item || item.type === 'Standard') return; const maxEl = document.getElementById(`max-${id}`); if(maxEl) { if (item.max <= item.min && item.max !== 0) maxEl.classList.add('border-red-500', 'bg-red-50', 'text-red-600'); else maxEl.classList.remove('border-red-500', 'bg-red-50', 'text-red-600'); } };
        window.validateStatusUI = (id) => { const item = window.state.items.find(i => i.id === id); const row = document.getElementById(`row-${id}`); if (!item || !row) return; const stCell = row.querySelector('.status-cell'); const actVal = parseFloat(item.actual); if (isNaN(actVal) || item.actual === '') { stCell.innerHTML = ''; return; } stCell.innerHTML = (actVal >= item.min && actVal <= item.max) ? `<span class="text-green-600">${t('val_pass')}</span>` : `<span class="text-red-600">${t('val_fail')}</span>`; };
        window.updateItem = (id, field, value) => { const item = window.state.items.find(i => i.id === id); if(item) item[field] = value; };
        window.removeItem = (id) => { window.state.items = window.state.items.filter(i => i.id !== id); window.renderTable(); };
        window.duplicateItem = (id) => { const item = window.state.items.find(i => i.id === id); if (item) { window.state.items.splice(window.state.items.findIndex(i => i.id === id) + 1, 0, { ...item, id: `dup-${Date.now()}`, type: 'Manual', actual: '' }); window.renderTable(); } };
        window.addManualItem = () => { window.state.items.push({ id: `man-${Date.now()}`, type: 'Manual', station: '', part: '', min: 0, max: 0, actual: '' }); window.renderTable(); };

        window.submitData = async () => {
            if(!window.state.formData.line || !window.state.formData.leaderName) return window.showToast("Please fill Line and Leader name.", "error");
            if(window.state.items.some(i => i.type === 'Manual' && (!i.station || !i.part || i.min==='' || i.max===''))) return window.showToast("Incomplete manual items.", "error");
            
            const btn = document.getElementById('btn-submit'); 
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Saving...';
            lucide.createIcons();

            try {
                // Auto-learn Standards Logic
                const newManuals = window.state.items.filter(i => i.type === 'Manual' && i.station && i.part && i.min > 0 && i.max > i.min);
                if (newManuals.length > 0) {
                   const uniqueNew = newManuals.filter(nm => !window.state.config.standards.some(s => String(s.line)===String(window.state.formData.line) && s.modelGroup===(window.state.formData.mainModel||'Manual') && s.station===nm.station && s.part===nm.part));
                   if (uniqueNew.length > 0 && confirm(`Save ${uniqueNew.length} new items to standards?`)) {
                        uniqueNew.forEach(nm => ConfigService.addStandard({ modelGroup: window.state.formData.mainModel||'Manual', subModel: window.state.formData.subModel||'', line: window.state.formData.line, station: nm.station, part: nm.part, minNm: parseFloat(nm.min), maxNm: parseFloat(nm.max) }));
                        window.showToast("New standards saved!", 'success');
                   }
                }
                const readings = window.state.items.map(i => { const act = parseFloat(i.actual); return {...i, status: (!isNaN(act) && act >= i.min && act <= i.max) ? 'pass' : 'fail', standardMin: i.min, standardMax: i.max}; });
                
                await Service.saveRecord({
                    ...window.state.formData, 
                    dateString: new Date().toLocaleString('th-TH'), 
                    readings
                });
                
                window.loadItemsFromStandard();
            } catch(e) { console.error(e); window.showToast("Error saving record.", "error"); }
            finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        };

        // --- VISUALIZATION & HISTORY ---
        function getFilteredData(startDateStr, endDateStr) { 
             let data = window.state.historyData || [];
             const parseDate = (str) => { let parts = str.split(/[\s,/]+/); if (parts.length >= 3) { const y = parseInt(parts[2], 10); return new Date(y > 2400 ? y - 543 : y, parseInt(parts[1], 10) - 1, parseInt(parts[0], 10)); } return new Date(str); };
             const start = startDateStr ? new Date(startDateStr) : null; if(start) start.setHours(0,0,0,0);
             const end = endDateStr ? new Date(endDateStr) : null; if(end) end.setHours(23,59,59,999);
             if (start || end) data = data.filter(item => { try { const d = parseDate(item.dateString); if (isNaN(d.getTime())) return true; if (start && d < start) return false; if (end && d > end) return false; return true; } catch (e) { return true; } });
             return data;
        }

       // ---------------------------------------------------------
        // 1. ฟังก์ชันแสดงผลตาราง (Main Render Function)
        // ---------------------------------------------------------
        window.renderHistoryTable = () => {
            const currentUser = window.state.user;
            
            // ถ้าไม่มี User (หลุด Login) ให้เคลียร์ตาราง
            if (!currentUser) {
                document.getElementById('history-table-body').innerHTML = '';
                return;
            }

            const isAdmin = currentUser.role === 'admin';
            const currentName = (currentUser.name || '').trim().toLowerCase();
            
            // เตรียมวันที่ปัจจุบัน (00:00:00) เพื่อใช้เช็คกฎ "ลบได้เฉพาะวันนี้"
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // ฟังก์ชันช่วยแปลงวันที่ (รองรับ พ.ศ.)
            const parseDate = (str) => {
                if (!str) return new Date(0);
                let parts = str.split(/[\s,/]+/);
                if (parts.length >= 3) {
                    const d = parseInt(parts[0], 10);
                    const m = parseInt(parts[1], 10) - 1;
                    let y = parseInt(parts[2], 10);
                    return new Date(y > 2400 ? y - 543 : y, m, d);
                }
                return new Date(str);
            };

            // ซ่อนปุ่ม Clear Local History สำหรับ User ทั่วไป
            const btnClear = document.querySelector('button[onclick="clearHistory()"]');
            if (btnClear) {
                btnClear.classList.toggle('hidden', !isAdmin);
            }

            // ดึงข้อมูล + Filter + Sort
            let data = getFilteredData(document.getElementById('hist-date-start')?.value, document.getElementById('hist-date-end')?.value);
            if (window.state.sortHistory.col) {
                data = window.sortArray(data, window.state.sortHistory.col, window.state.sortHistory.dir);
            }

            const tbody = document.getElementById('history-table-body');
            
            // กรณีไม่มีข้อมูล
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-slate-400 italic">${t('table_no_data')}</td></tr>`;
                return;
            }

            // Loop สร้าง HTML
            tbody.innerHTML = data.map(r => {
                // --- ตรวจสอบสิทธิ์ (Security Check) ---
                const recordLeader = (r.leaderName || '').trim().toLowerCase();
                const recordQC = (r.qcName || '').trim().toLowerCase();
                
                // 1. เป็นเจ้าของหรือไม่? (เช็คทั้ง Leader และ QC)
                const isOwner = (currentName === recordLeader) || (currentName === recordQC);
                
                // 2. เป็นรายการวันนี้หรือไม่?
                const recDate = parseDate(r.dateString);
                recDate.setHours(0, 0, 0, 0);
                const isToday = recDate.getTime() === today.getTime();

                // สรุป: ลบได้ถ้าเป็น Admin หรือ (เป็นเจ้าของ และ เป็นรายการวันนี้)
                const canDelete = isAdmin || (isOwner && isToday);
                // --------------------------------------

                // เลือกปุ่มที่จะแสดง (ถังขยะ หรือ กุญแจ)
                const deleteActionBtn = canDelete
                    ? `<button onclick="handleDeleteWithUndo('${r.id}')" class="p-2 hover:bg-red-50 rounded transition touch-target group" title="ลบรายการ (Undo ได้)">
                         <i data-lucide="trash-2" class="w-4 h-4 text-red-400 group-hover:text-red-600"></i>
                       </button>`
                    : `<span class="p-2 inline-block text-slate-300 cursor-not-allowed" title="ไม่มีสิทธิ์ลบ">
                         <i data-lucide="lock" class="w-3 h-3"></i>
                       </span>`;

                const overallStatus = r.readings.every(rd => rd.status === 'pass') 
                    ? `<span class="text-green-600 font-bold">${t('val_pass')}</span>` 
                    : `<span class="text-red-600 font-bold">${t('val_fail')}</span>`;

                // เพิ่ม id="hist-row-..." ที่ <tr> เพื่อให้ระบบ Undo ซ่อน/แสดง แถวได้ถูกต้อง
                return `
                    <tr id="hist-row-${r.id}" class="hover:bg-slate-50 transition border-b border-slate-100">
                        <td class="p-3 text-xs whitespace-nowrap">${r.dateString}</td>
                        <td class="p-3 text-center font-bold">${escapeHtml(r.line)}</td>
                        <td class="p-3 text-xs">
                            <div class="font-bold text-slate-700">${escapeHtml(r.mainModel)}</div>
                            <div class="text-slate-500">${escapeHtml(r.subModel || '')}</div>
                        </td>
                        <td class="p-3 text-xs">
                            <div><span class="font-bold text-slate-400">L:</span> ${escapeHtml(r.leaderName)}</div>
                            <div><span class="font-bold text-slate-400">Q:</span> ${escapeHtml(r.qcName)}</div>
                        </td>
                        <td class="p-3 text-center">${overallStatus}</td>
                        <td class="p-3 text-center">
                            <button onclick="viewHistoryDetail('${r.id}')" class="p-2 hover:bg-blue-50 rounded transition touch-target">
                                <i data-lucide="search" class="w-4 h-4 text-blue-500"></i>
                            </button>
                        </td>
                        <td class="p-3 text-center">
                            ${deleteActionBtn}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Render ไอคอนใหม่
            lucide.createIcons();
        };

        // ---------------------------------------------------------
        // 2. ระบบจัดการ Undo (Delete Logic)
        // ---------------------------------------------------------
        
        // ตัวแปรเก็บ Timer ของแต่ละรายการที่กำลังรอการลบ
        window.deleteTimers = {}; 

        // ฟังก์ชันเมื่อกดปุ่มถังขยะ
        window.handleDeleteWithUndo = (id) => {
            // 1. ถามยืนยัน (Confirmation)
            if (!confirm(t('alert_delete_confirm'))) {
                return;
            }

            // 2. ซ่อนแถวทันที (Soft Delete - Optimistic UI)
            const row = document.getElementById(`hist-row-${id}`);
            if (row) {
                row.style.transition = "opacity 0.3s, transform 0.3s";
                row.style.opacity = "0";
                row.style.transform = "translateX(-20px)";
                setTimeout(() => row.style.display = "none", 300);
            }

            // 3. แสดง Toast พร้อมปุ่ม Undo
            showUndoToast(id);

            // 4. ตั้งเวลา 5 วินาที ถ้าไม่มีการกด Undo ให้ลบจริง
            window.deleteTimers[id] = setTimeout(() => {
                // ส่งคำสั่งลบไป Google Sheet จริงๆ
                Service.deleteRecord(id); 
                
                // เคลียร์ Timer และ Toast
                delete window.deleteTimers[id];
                const undoToast = document.getElementById(`toast-undo-${id}`);
                if (undoToast) {
                     undoToast.classList.remove('show');
                     setTimeout(() => undoToast.remove(), 300);
                }
            }, 5000); 
        };

        // ฟังก์ชันเมื่อกดปุ่ม Undo
        window.cancelDelete = (id) => {
            // 1. หยุด Timer การลบ (สำคัญมาก!)
            if (window.deleteTimers[id]) {
                clearTimeout(window.deleteTimers[id]);
                delete window.deleteTimers[id];
            }

            // 2. ดึงแถวตารางกลับมา (Restore Row)
            const row = document.getElementById(`hist-row-${id}`);
            if (row) {
                row.style.display = "";
                requestAnimationFrame(() => {
                    row.style.opacity = "1";
                    row.style.transform = "translateX(0)";
                    row.classList.add("bg-green-50"); // ไฮไลท์สีเขียวให้รู้ว่ากลับมาแล้ว
                    setTimeout(() => row.classList.remove("bg-green-50"), 1000);
                });
            }

            // 3. ปิด Toast Undo ทันที
            const undoToast = document.getElementById(`toast-undo-${id}`);
            if (undoToast) {
                undoToast.classList.remove('show');
                setTimeout(() => undoToast.remove(), 300);
            }

            // แจ้งเตือนเล็กน้อยว่ากู้คืนแล้ว
            // window.showToast("ยกเลิกการลบเรียบร้อย", "success");
        };

        // ฟังก์ชันสร้าง Toast สำหรับ Undo
        window.showUndoToast = (id) => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.id = `toast-undo-${id}`;
            // ใช้ Style ของ Toast-undo (พื้นหลังดำ)
            toast.className = `toast toast-undo show flex items-center gap-4 justify-between`;
            
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i data-lucide="trash" class="w-4 h-4 text-red-300"></i>
                    <span class="text-sm">${t('alert_delete_undo_msg')}</span>
                </div>
                <button onclick="cancelDelete('${id}')" class="px-3 py-1.5 bg-white text-slate-900 text-xs font-bold rounded hover:bg-slate-200 transition active:scale-95 flex items-center gap-1 shadow-sm">
                    <i data-lucide="undo-2" class="w-3 h-3"></i> ${t('alert_undo')}
                </button>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();

            // ตั้งเวลาให้ Toast หายไปเองถ้า User ไม่กดอะไร (เพื่อให้ UI ไม่รก)
            // หมายเหตุ: การลบจริงถูกจัดการโดย window.deleteTimers แล้ว อันนี้แค่เรื่อง UI
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        };

        window.updateDashboard = () => { 
             const data = getFilteredData(document.getElementById('dash-date-start')?.value, document.getElementById('dash-date-end')?.value);
             document.getElementById('stat-total').textContent = data.length;
             const passed = data.filter(r => r.readings.every(rd => rd.status === 'pass')).length;
             document.getElementById('stat-pass').textContent = passed; document.getElementById('stat-fail').textContent = data.length - passed;
             document.getElementById('stat-today').textContent = data.length; 

             if (typeof Chart === 'undefined') return;
             if(window.state.charts.ratio) window.state.charts.ratio.destroy();
             if(window.state.charts.activity) window.state.charts.activity.destroy();

             const ctx1 = document.getElementById('chart-ratio');
             if (ctx1) { window.state.charts.ratio = new Chart(ctx1, { type: 'doughnut', data: { labels: ['Pass', 'Fail'], datasets: [{ data: [passed, data.length - passed], backgroundColor: ['#10b981', '#ef4444'] }] }, options: { responsive: true, maintainAspectRatio: false } }); }
             
             const lineCounts = {}; data.forEach(r => { lineCounts[r.line] = (lineCounts[r.line] || 0) + 1; });
             const ctx2 = document.getElementById('chart-activity');
             if (ctx2) { window.state.charts.activity = new Chart(ctx2, { type: 'bar', data: { labels: Object.keys(lineCounts), datasets: [{ label: 'Inspections', data: Object.values(lineCounts), backgroundColor: '#3b82f6' }] }, options: { responsive: true, maintainAspectRatio: false } }); }
        };
        
        // --- SETTINGS (Standards) ---
        window.renderSettings = () => {
            document.getElementById('table-cfg-standards').innerHTML = window.state.config.standards.map((s, i) => `<tr><td class="p-3 text-xs font-bold text-slate-700">${escapeHtml(s.modelGroup)}</td><td class="p-3 text-xs text-slate-500">${escapeHtml(s.modelByTorq||'-')}</td><td class="p-3 text-xs text-blue-600 font-medium">${escapeHtml(s.subModel||'-')}</td><td class="p-3">${escapeHtml(s.line)}</td><td class="p-3">${escapeHtml(s.station)}</td><td class="p-3 text-xs">${escapeHtml(s.part)}</td><td class="p-3 text-center">${s.minNm}</td><td class="p-3 text-center">${s.maxNm}</td><td class="p-3"><div class="flex items-center gap-1 justify-center"><button onclick="editConfigStandard(${i})" class="text-blue-500 hover:bg-blue-50 p-2 rounded touch-target"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="ConfigService.removeStandard(${i}); renderSettings()" class="text-red-500 hover:bg-red-50 p-2 rounded touch-target"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td></tr>`).join('');
            document.getElementById('table-cfg-parts').innerHTML = window.state.config.parts.map((p, i) => `<tr><td class="p-2">${escapeHtml(p)}</td><td class="p-2"><button onclick="ConfigService.removePart(${i}); renderSettings()" class="text-red-400 hover:text-red-600 p-2 touch-target"><i data-lucide="x-circle" class="w-4 h-4"></i></button></td></tr>`).join('');
            AuthManager.syncUsersList(); 
            lucide.createIcons();
        };

        window.addConfigStandard = () => { 
            const g = document.getElementById('cfg-std-group').value.trim();
            const min = parseFloat(document.getElementById('cfg-std-min').value);
            const max = parseFloat(document.getElementById('cfg-std-max').value);
            const part = document.getElementById('cfg-std-part').value.trim();

            if(g && !isNaN(min) && !isNaN(max)) { 
                if(!part) return alert("Please enter a Part Number");
                
                const newStd = {
                    modelGroup: g, modelByTorq: document.getElementById('cfg-std-torq-model').value.trim(),
                    subModel: document.getElementById('cfg-std-sub').value.trim(),
                    line: document.getElementById('cfg-std-line').value.trim(),
                    station: document.getElementById('cfg-std-station').value.trim(),
                    part: part,
                    minNm: min, maxNm: max
                };
                if (window.state.editStandardIndex !== null) { ConfigService.updateStandard(window.state.editStandardIndex, newStd); window.cancelEditStandard(); } 
                else { ConfigService.addStandard(newStd); }
                window.renderSettings(); 
            } else alert("Please fill required fields (Model, Part, Min, Max).");
        };

        window.editConfigStandard = (index) => {
            const std = window.state.config.standards[index];
            document.getElementById('cfg-std-group').value = std.modelGroup || '';
            document.getElementById('cfg-std-sub').value = std.subModel || '';
            document.getElementById('cfg-std-torq-model').value = std.modelByTorq || '';
            document.getElementById('cfg-std-line').value = std.line || '';
            document.getElementById('cfg-std-station').value = std.station || '';
            document.getElementById('cfg-std-part').value = std.part || '';
            document.getElementById('cfg-std-min').value = std.minNm;
            document.getElementById('cfg-std-max').value = std.maxNm;
            window.state.editStandardIndex = index;
            document.getElementById('edit-mode-indicator').classList.remove('hidden');
            document.getElementById('edit-index').textContent = index + 1;
            const btn = document.getElementById('btn-add-standard');
            btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Update Standard';
            btn.classList.replace('bg-green-600', 'bg-blue-600');
            btn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
            lucide.createIcons(); document.getElementById('settings-standards').scrollIntoView({ behavior: 'smooth' });
        };

        window.cancelEditStandard = () => {
            window.state.editStandardIndex = null;
            document.getElementById('edit-mode-indicator').classList.add('hidden');
            const btn = document.getElementById('btn-add-standard');
            btn.innerHTML = '<i data-lucide="plus-circle" class="w-4 h-4"></i> Add Standard';
            btn.classList.replace('bg-blue-600', 'bg-green-600');
            btn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
            document.getElementById('cfg-std-station').value = ''; document.getElementById('cfg-std-part').value = ''; 
            document.getElementById('cfg-std-min').value = ''; document.getElementById('cfg-std-max').value = ''; 
            document.getElementById('cfg-std-sub').value = ''; lucide.createIcons();
        };

        window.addManualPart = () => { const val = document.getElementById('cfg-part-new').value.trim(); if (val) { ConfigService.addUniquePart(val); ConfigService.save(); document.getElementById('cfg-part-new').value = ''; window.renderSettings(); } };
        window.checkConfigMinMax = () => { const min = parseFloat(document.getElementById('cfg-std-min').value); const max = parseFloat(document.getElementById('cfg-std-max').value); const maxInput = document.getElementById('cfg-std-max'); if(!isNaN(min) && !isNaN(max) && max <= min) maxInput.classList.add('border-red-500', 'bg-red-50'); else maxInput.classList.remove('border-red-500', 'bg-red-50'); };

        // --- DATA IMPORT/EXPORT ---
        window.downloadTemplate = (type) => {
            let csv = "", filename = "";
            if(type === 'models') { csv = "MainModel,SubModel\nLC CLASSIC,EZBOX100"; filename = "models_tmpl.csv"; }
            else { csv = "Main model,Sub model,Part No.,Line,ST,Min,Max\nCU Classic,S9HCL110,75504066AA,5,6,2.6,3.05"; filename = "std_tmpl.csv"; }
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        };

        window.importData = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                let text = e.target.result.replace(/^\uFEFF/, '');
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
                if (lines.length < 2) return;
                
                const headers = lines[0].split(',').map(h => 
                    h.trim().toLowerCase()
                    .replace(/\(n\.m\)/g, '')
                    .replace(/\./g,'')
                    .replace(/\s+/g, '') 
                );
                
                let count = { models: 0, standards: 0 };
                
                lines.slice(1).forEach(line => {
                    const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if (!cols) return;
                    const cleanCols = cols.map(c => c.replace(/^"|"$/g, '').trim());
                    const row = {}; headers.forEach((h, i) => row[h] = cleanCols[i] || '');

                    const main = row['mainmodel'] || row['main model'];
                    const sub = row['submodel'] || row['sub model'];
                    if (main && sub) { if (!window.state.config.models.some(m => m.main === main && m.sub === sub)) { ConfigService.addModel(main, sub); count.models++; } }

                    const min = parseFloat(row['min'] || row['minnm']);
                    const max = parseFloat(row['max'] || row['maxnm']);
                    const lineVal = row['line'];
                    
                    if (!isNaN(min) && !isNaN(max) && lineVal) {
                        ConfigService.addStandard({
                            modelGroup: main || row['modelbytorq'] || 'Unknown',
                            modelByTorq: row['modelbytorq'] || '',
                            subModel: sub || '',
                            line: lineVal,
                            station: row['st'] || '-',
                            part: row['partnumber'] || row['part'] || row['partno'] || '-',
                            desc: row['objdesc'] || '',
                            minNm: min, maxNm: max
                        });
                        count.standards++;
                    }
                });
                alert(`Import Complete!\nModels: ${count.models}\nStandards: ${count.standards}`); window.renderSettings();
            };
            reader.readAsText(file);
        };

        // --- MISC UTILS ---
        window.clearHistory = () => { 
            const msg = "Clear LOCAL history only? (Cloud data remains safe)";
            if (!confirm(msg)) return;
            localStorage.setItem('torque_records', '[]');
            Service.subscribeHistory();
            window.showToast("Local history cleared.", 'undo');
        };

        window.exportToCSV = () => {
            const filteredData = getFilteredData(document.getElementById('hist-date-start')?.value, document.getElementById('hist-date-end')?.value);
            if (filteredData.length === 0) return alert("No data to export.");
            let csv = "\uFEFFDate,Line,MainModel,SubModel,Leader,QC,Station,Part,Min,Max,Actual,Status,Result\n";
            filteredData.forEach(r => {
                const overallResult = r.readings.every(rd => rd.status === 'pass') ? 'PASS' : 'FAIL';
                r.readings.forEach(rd => {
                    csv += `${r.dateString},${r.line},"${r.mainModel}","${r.subModel}","${r.leaderName}","${r.qcName}","${rd.station}","${rd.part}",${rd.min||0},${rd.max||0},${rd.actual},${rd.status.toUpperCase()},${overallResult}\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `torque_export_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        };

        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let content = '', bgClass = '';
            if (type === 'success') { bgClass = 'toast-success'; content = `<div class="flex items-center gap-2"><i data-lucide="check-circle" class="w-5 h-5"></i><span>${msg}</span></div>`; } 
            else if (type === 'info') { bgClass = 'toast-info'; content = `<div class="flex items-center gap-2"><i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i><span>${msg}</span></div>`; } 
            else if (type === 'undo') { bgClass = 'toast-undo'; content = `<div class="flex items-center gap-2"><span>${msg}</span></div>`; } 
            else if (type === 'error') { bgClass = 'toast-error'; content = `<div class="flex items-center gap-2"><i data-lucide="alert-circle" class="w-5 h-5"></i><span>${msg}</span>
